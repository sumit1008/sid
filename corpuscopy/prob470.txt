G2. Spinning Round (Hard Version)
This is the hard version of the problem. The only difference between the two versions are the allowed characters in ğ‘ s. You can make hacks only if both versions of the problem are solved.
You are given a permutation ğ‘p of length ğ‘›n. You are also given a string ğ‘ s of length ğ‘›n, where each character is either L, R, or ?.
For each ğ‘–i from 11 to ğ‘›n:
  - Define ğ‘™ğ‘–li as the largest index ğ‘—<ğ‘–j<i such that ğ‘ğ‘—>ğ‘ğ‘–pj>pi. If there is no such index, ğ‘™ğ‘–:=ğ‘–li:=i.
  - Define ğ‘Ÿğ‘–ri as the smallest index ğ‘—>ğ‘–j>i such that ğ‘ğ‘—>ğ‘ğ‘–pj>pi. If there is no such index, ğ‘Ÿğ‘–:=ğ‘–ri:=i.
Initially, you have an undirected graph with ğ‘›n vertices (numbered from 11 to ğ‘›n) and no edges. Then, for each ğ‘–i from 11 to ğ‘›n, add one edge to the graph:
  - If ğ‘ ğ‘–=si=Â L, add the edge (ğ‘–,ğ‘™ğ‘–)(i,li) to the graph.
  - If ğ‘ ğ‘–=si=Â R, add the edge (ğ‘–,ğ‘Ÿğ‘–)(i,ri) to the graph.
  - If ğ‘ ğ‘–=si=Â ?, either add the edge (ğ‘–,ğ‘™ğ‘–)(i,li) or the edge (ğ‘–,ğ‘Ÿğ‘–)(i,ri) to the graph at your choice.
Find the maximum possible diameter over all connectedâˆ—âˆ— graphs that you can form. Output âˆ’1âˆ’1 if it is not possible to form any connected graphs.
Tags -divide and conquer
Tags -dp
Tags -trees
Tags -*3500
